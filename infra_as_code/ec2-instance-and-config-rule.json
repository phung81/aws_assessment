{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Create an EC2 instance and a config rule that evaluates EC2 instances to ensure no public IP is configured.",
   "Resources":{
      "EC2Instance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "ImageId":"ami-0a02ee601d742e89f",
            "InstanceType":"t2.micro",
            "SubnetId":{
               "Ref":"PrivateSubnet"
            }
         }
      },
      "VPC":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":"10.0.0.0/16",
            "EnableDnsHostnames":false,
            "EnableDnsSupport":false
         }
      },
      "PrivateSubnet":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "CidrBlock":"10.0.0.0/24",
            "MapPublicIpOnLaunch":false,
            "VpcId":{
               "Ref":"VPC"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"Private Subnet for EC2Instance"
               }
            ],
            "AvailabilityZone":{
               "Fn::Select":[
                  "0",
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWS::Region"
                     }
                  }
               ]
            }
         }
      },
      "ConfigRecorder":{
         "Type":"AWS::Config::ConfigurationRecorder",
         "Properties":{
            "Name":"default",
            "RecordingGroup":{
               "ResourceTypes":[
                  "AWS::EC2::Instance"
               ]
            },
            "RoleARN":{
               "Fn::GetAtt":[
                  "ConfigRole",
                  "Arn"
               ]
            }
         }
      },
      "DeliveryChannel":{
         "Type":"AWS::Config::DeliveryChannel",
         "Properties":{
            "ConfigSnapshotDeliveryProperties":{
               "DeliveryFrequency":"Six_Hours"
            },
            "S3BucketName":{
               "Ref":"ConfigBucket"
            }
         }
      },
      "ConfigBucket":{
         "Type":"AWS::S3::Bucket"
      },
      "ConfigRule":{
         "Type":"AWS::Config::ConfigRule",
         "Properties":{
            "ConfigRuleName":"ec2-instance-no-public-ip",
            "Description":"A Config rule that checks whether Amazon Elastic Compute Cloud (Amazon EC2) instances have a public IP association. The rule is NON_COMPLIANT if the publicIp field is present in the Amazon EC2 instance configuration item. This rule applies only to IPv4",
            "Scope":{
               "ComplianceResourceTypes":[
                  "AWS::EC2::Instance"
               ]
            },
            "Source":{
               "Owner":"AWS",
               "SourceIdentifier":"EC2_INSTANCE_NO_PUBLIC_IP"
            }
         },
         "DependsOn":"ConfigRecorder"
      },
      "ConfigRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "config.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSConfigRole"
            ],
            "Policies":[
               {
                  "PolicyName":"root",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":"s3:GetBucketAcl",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"ConfigBucket"
                                    }
                                 ]
                              ]
                           }
                        },
                        {
                           "Effect":"Allow",
                           "Action":"s3:PutObject",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"ConfigBucket"
                                    },
                                    "/AWSLogs/",
                                    {
                                       "Ref":"AWS::AccountId"
                                    },
                                    "/*"
                                 ]
                              ]
                           },
                           "Condition":{
                              "StringEquals":{
                                 "s3:x-amz-acl":"bucket-owner-full-control"
                              }
                           }
                        },
                        {
                           "Effect":"Allow",
                           "Action":"config:Put*",
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      }
   },
   "Parameters":{

   },
   "Metadata":{

   },
   "Conditions":{

   }
}